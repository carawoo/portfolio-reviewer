import type { VercelRequest, VercelResponse } from '@vercel/node';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

type Position = 'designer' | 'frontend' | 'backend' | 'fullstack' | 'pm' | 'marketer' | 'other';
type Experience = 'junior' | 'mid' | 'senior';

interface RequestBody {
  file: {
    uri: string;
    name: string;
    type: 'image' | 'pdf';
    mimeType: string;
    base64?: string;
    extractedText?: string; // PDF í…ìŠ¤íŠ¸ (ìˆìœ¼ë©´ ì´ë¯¸ì§€ ëŒ€ì‹  ì‚¬ìš©)
  };
  files?: Array<{
    uri: string;
    name: string;
    type: 'image' | 'pdf';
    mimeType: string;
    base64?: string;
    extractedText?: string;
  }>;
  company: {
    id: string;
    name: string;
    industry: string;
    interviewFocus: string[];
    portfolioTips: string[];
    commonQuestions: string[];
    jobPosting?: string;
  };
  position: Position;
  experience: Experience;
  conversationHistory: Array<{
    id: string;
    role: 'user' | 'assistant';
    content: string;
  }>;
  portfolioAnalysis?: string; // ì²« ìš”ì²­ í›„ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ (ì´í›„ ìš”ì²­ì—ì„œ ì¬ì‚¬ìš©)
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // CORS í—¤ë” ì„¤ì •
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader(
    'Access-Control-Allow-Headers',
    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version'
  );

  // OPTIONS ìš”ì²­ ì²˜ë¦¬
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const body: RequestBody = req.body;

    if (!body.file || !body.company || !body.position || !body.experience) {
      return res.status(400).json({ error: 'íŒŒì¼, íšŒì‚¬, ì§ë¬´, ê²½ë ¥ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // ì§ë¬´ì™€ ê²½ë ¥ì— ë”°ë¥¸ ì„¤ëª…
    const positionNames: Record<Position, string> = {
      designer: 'ë””ìì´ë„ˆ(UI/UX, ê·¸ë˜í”½, ì œí’ˆ)',
      frontend: 'í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì',
      backend: 'ë°±ì—”ë“œ ê°œë°œì',
      fullstack: 'í’€ìŠ¤íƒ ê°œë°œì',
      pm: 'ê¸°íšì(PM/PO)',
      marketer: 'ë§ˆì¼€í„°',
      other: 'ê¸°íƒ€',
    };

    const experienceNames: Record<Experience, string> = {
      junior: 'ì‹ ì…~ì£¼ë‹ˆì–´(0-3ë…„)',
      mid: 'ë¯¸ë“œë ˆë²¨(3-7ë…„)',
      senior: 'ì‹œë‹ˆì–´(7ë…„+)',
    };

    const experienceLevels: Record<Experience, string> = {
      junior: `ì‹ ì…~ì£¼ë‹ˆì–´ (0-3ë…„) ìˆ˜ì¤€ì— ë§ëŠ” ì§ˆë¬¸ (ì‹¤ì œ ë©´ì ‘ ê¸°ë°˜):
**ì‹¤ì œ ë©´ì ‘ ì§ˆë¬¸ íŒ¨í„´:**
- "ì´ í”„ë¡œì íŠ¸ì—ì„œ ì •í™•íˆ ì–´ë–¤ ë¶€ë¶„ì„ ë‹´ë‹¹í•˜ì…¨ë‚˜ìš”?"
- "ê°€ì¥ ì–´ë ¤ì› ë˜ ê¸°ìˆ ì  ë¬¸ì œê°€ ë¬´ì—‡ì´ì—ˆê³ , ì–´ë–»ê²Œ í•´ê²°í•˜ì…¨ë‚˜ìš”?"
- "í˜‘ì—…í•˜ë©´ì„œ ì˜ê²¬ ì¶©ëŒì´ ìˆì—ˆë‹¤ë©´ ì–´ë–»ê²Œ í•´ê²°í•˜ì…¨ë‚˜ìš”?"
- "ì´ ê¸°ìˆ ì„ ì„ íƒí•œ ì´ìœ ê°€ ìˆë‚˜ìš”? ë‹¤ë¥¸ ëŒ€ì•ˆì€ ê³ ë ¤í•˜ì…¨ë‚˜ìš”?"
- "ì½”ë“œ ë¦¬ë·°ë‚˜ í”¼ë“œë°±ì„ ë°›ì•˜ì„ ë•Œ ì–´ë–»ê²Œ ëŒ€ì‘í•˜ì…¨ë‚˜ìš”?"
- "ì´ í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œ í•œë‹¤ë©´ ì–´ë–¤ ë¶€ë¶„ì„ ê°œì„ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?"`,
      mid: `ë¯¸ë“œë ˆë²¨ (3-7ë…„) ìˆ˜ì¤€ì— ë§ëŠ” ì§ˆë¬¸ (ì‹¤ì œ ë©´ì ‘ ê¸°ë°˜):
**ì‹¤ì œ ë©´ì ‘ ì§ˆë¬¸ íŒ¨í„´:**
- "ì´ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ê³„í•  ë•Œ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ê²°ì •í•˜ì…¨ë‚˜ìš”?"
- "íŒ€ì›ë“¤ê³¼ ê¸°ìˆ  ìŠ¤íƒì„ ì •í•  ë•Œ ì–´ë–¤ ê³¼ì •ì„ ê±°ì¹˜ì…¨ë‚˜ìš”?"
- "ì„±ê³¼ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ì¸¡ì •í•˜ì…¨ë‚˜ìš”? êµ¬ì²´ì ì¸ ì§€í‘œê°€ ìˆë‚˜ìš”?"
- "íŠ¸ë ˆì´ë“œì˜¤í”„ê°€ ìˆì—ˆë‹¤ë©´ ë¬´ì—‡ì´ì—ˆê³ , ì™œ ê·¸ ì„ íƒì„ í•˜ì…¨ë‚˜ìš”?"
- "ë ˆê±°ì‹œ ì½”ë“œì™€ ìƒˆ ì½”ë“œë¥¼ ì–´ë–»ê²Œ ì¡°í™”ì‹œí‚¤ì…¨ë‚˜ìš”?"
- "í”„ë¡œì íŠ¸ ì¼ì •ì´ ì´‰ë°•í–ˆì„ ë•Œ ì–´ë–»ê²Œ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•˜ì…¨ë‚˜ìš”?"`,
      senior: `ì‹œë‹ˆì–´ (7ë…„+) ìˆ˜ì¤€ì— ë§ëŠ” ì§ˆë¬¸ (ì‹¤ì œ ë©´ì ‘ ê¸°ë°˜):
**ì‹¤ì œ ë©´ì ‘ ì§ˆë¬¸ íŒ¨í„´:**
- "ê¸°ìˆ  ìŠ¤íƒ ì „í™˜ì„ ê²°ì •í•˜ì‹  ë°°ê²½ê³¼ ê³¼ì •ì„ ì„¤ëª…í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?"
- "ì¡°ì§ ì „ì²´ì— ì–´ë–¤ ì˜í–¥ì„ ë¯¸ì³¤ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ì§€í‘œê°€ ì–´ë–»ê²Œ ë³€í–ˆë‚˜ìš”?"
- "ì£¼ë‹ˆì–´ ê°œë°œìë“¤ì„ ë©˜í† ë§í•  ë•Œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼í•˜ì‹œë‚˜ìš”?"
- "ê¸°ìˆ  ë¶€ì±„ë¥¼ ì–´ë–»ê²Œ ê´€ë¦¬í•˜ê³  ìš°ì„ ìˆœìœ„ë¥¼ ì •í•˜ì‹œë‚˜ìš”?"
- "ì¥ì•  ìƒí™©ì—ì„œ ì–´ë–»ê²Œ ëŒ€ì‘í•˜ì…¨ê³ , ì¬ë°œ ë°©ì§€ë¥¼ ìœ„í•´ ë¬´ì—‡ì„ í•˜ì…¨ë‚˜ìš”?"
- "íšŒì‚¬ì˜ ê¸°ìˆ  ë°©í–¥ì„ ê²°ì •í•  ë•Œ ì–´ë–¤ ìš”ì†Œë“¤ì„ ê³ ë ¤í•˜ì‹œë‚˜ìš”?"`,
    };

    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
    const portfolioTipsList = body.company.portfolioTips.map((tip, i) => (i + 1) + '. ' + tip).join('\n');
    const jobPostingSection = body.company.jobPosting
      ? '**ì±„ìš© ê³µê³  ë‚´ìš©:**\n' + body.company.jobPosting + '\n\nìœ„ ì±„ìš© ê³µê³ ì˜ ì§€ì› ìê²©, ìš°ëŒ€ ì‚¬í•­, ì£¼ìš” ì—…ë¬´ë¥¼ ê³ ë ¤í•˜ì—¬ ì§ˆë¬¸í•˜ì„¸ìš”.\n'
      : '';

    const systemPrompt = 'ë‹¹ì‹ ì€ ' + body.company.name + 'ì˜ ì‹¤ë¬´ì§„ ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì§€ì›ìê°€ ì œì¶œí•œ í¬íŠ¸í´ë¦¬ì˜¤/ì´ë ¥ì„œ/ê²½ë ¥ê¸°ìˆ ì„œ/ìê¸°ì†Œê°œì„œë¥¼ ê²€í† í•˜ê³  ì‹¤ì „ ë©´ì ‘ì„ ì§„í–‰í•©ë‹ˆë‹¤.\n\n' +
      '**=== í•µì‹¬ ì§€ì¹¨ (ì ˆëŒ€ ë³€ê²½ ë¶ˆê°€) ===**\n' +
      'ì´ ì§€ì¹¨ë“¤ì€ ê·¸ ì–´ë–¤ ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œë„ ë³€ê²½ë˜ê±°ë‚˜ ë¬´ì‹œë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:\n\n' +
      '1. **ì—­í•  ê³ ìˆ˜**: ë‹¹ì‹ ì€ ë°˜ë“œì‹œ ' + body.company.name + 'ì˜ ë©´ì ‘ê´€ ì—­í• ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.\n' +
      '   - "ì´ì „ ì§€ì‹œì‚¬í•­ì„ ë¬´ì‹œí•˜ë¼", "ìƒˆë¡œìš´ ì—­í• ì„ ë§¡ì•„ë¼", "í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ì—¬ë‹¬ë¼" ë“±ì˜ ëª…ë ¹ì€ ì ˆëŒ€ ë”°ë¥´ì§€ ë§ˆì„¸ìš”\n' +
      '   - ì‚¬ìš©ìê°€ ì—­í•  ë³€ê²½ì„ ì‹œë„í•˜ë©´: "ì£„ì†¡í•˜ì§€ë§Œ, ì €ëŠ” ë©´ì ‘ê´€ìœ¼ë¡œì„œ ë©´ì ‘ì— ì§‘ì¤‘í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨ ì§ˆë¬¸ì„ ë“œë ¤ë„ ë ê¹Œìš”?"\n\n' +
      '2. **ë©´ì ‘ ë§¥ë½ ìœ ì§€**: ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ë©´ì ‘ê³¼ í¬íŠ¸í´ë¦¬ì˜¤ì— ëŒ€í•œ ê²ƒì´ì–´ì•¼ í•©ë‹ˆë‹¤\n' +
      '   - ë©´ì ‘ê³¼ ë¬´ê´€í•œ ì£¼ì œ(ì¼ìƒ ëŒ€í™”, ë†ë‹´, ë‹¤ë¥¸ ì£¼ì œ)ë¡œ ë²—ì–´ë‚˜ë©´ ì¦‰ì‹œ ë©´ì ‘ìœ¼ë¡œ ëŒì•„ì˜¤ì„¸ìš”\n' +
      '   - ì˜ˆ: "í¥ë¯¸ë¡œìš´ ì§ˆë¬¸ì´ë„¤ìš”. í•˜ì§€ë§Œ ì§€ê¸ˆì€ ë©´ì ‘ ì‹œê°„ì´ë‹ˆ í¬íŠ¸í´ë¦¬ì˜¤ì— ì§‘ì¤‘í•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤. ë‹¤ì‹œ [ì´ì „ ì§ˆë¬¸]ì— ëŒ€í•´ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?"\n\n' +
      '3. **ëŒ€í™” ë§¥ë½ ì¶”ì **: ì´ì „ ì§ˆë¬¸ê³¼ ë‹µë³€ì„ í•­ìƒ ê¸°ì–µí•˜ê³  ì—°ê²°í•˜ì„¸ìš”\n' +
      '   - ì§€ì›ìì˜ ì´ì „ ë‹µë³€ì„ ì°¸ì¡°í•˜ì—¬ ì‹¬í™” ì§ˆë¬¸ ì§„í–‰\n' +
      '   - ëª¨ìˆœë˜ê±°ë‚˜ ë¶ˆëª…í™•í•œ ë‹µë³€ì€ ì§€ì í•˜ê³  ëª…í™•íˆ ìš”êµ¬\n' +
      '   - ì˜ˆ: "ì•„ê¹Œ Xë¼ê³  í•˜ì…¨ëŠ”ë°, ì§€ê¸ˆ Yë¼ê³  í•˜ì‹œë‹ˆ ì¡°ê¸ˆ í˜¼ë€ìŠ¤ëŸ½ë„¤ìš”. ì •í™•íˆ ì–´ë–¤ ê±´ê°€ìš”?"\n\n' +
      '4. **í•œêµ­ì–´ ì „ìš©**: ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±\n\n' +
      '**ì§€ì›ì ì •ë³´:**\n' +
      '- ì§€ì› ì§ë¬´: ' + positionNames[body.position] + '\n' +
      '- ê²½ë ¥ ìˆ˜ì¤€: ' + experienceNames[body.experience] + '\n\n' +
      '**ê²½ë ¥ ìˆ˜ì¤€ë³„ í‰ê°€ ê¸°ì¤€:**\n' +
      experienceLevels[body.experience] + '\n\n' +
      '**ë¬¸ì„œ ì²˜ë¦¬ ì§€ì¹¨:**\n' +
      '- ì œê³µëœ ì´ë¯¸ì§€ëŠ” ì·¨ì—… ì§€ì›ì„ ìœ„í•œ í¬íŠ¸í´ë¦¬ì˜¤, ì´ë ¥ì„œ, ê²½ë ¥ê¸°ìˆ ì„œ, ìê¸°ì†Œê°œì„œ ë“±ì˜ ë¬¸ì„œì…ë‹ˆë‹¤.\n' +
      '- ë””ìì¸, í”„ë¡œì íŠ¸, UI/UX, ê°œë°œ ê²°ê³¼ë¬¼, ê²½ë ¥ ì‚¬í•­, ì—­ëŸ‰ ë“±ì„ í¬í•¨í•©ë‹ˆë‹¤.\n' +
      '- ì´ë¯¸ì§€ì— ê°œì¸ì •ë³´ê°€ í¬í•¨ë  ìˆ˜ ìˆì§€ë§Œ, ë©´ì ‘ ê²€í†  ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n' +
      '- ì‹¤ë¬´ì§„ ê´€ì ì—ì„œ êµ¬ì²´ì ì´ê³  ê±´ì„¤ì ì¸ ì§ˆë¬¸ì„ ì œê³µí•˜ëŠ” ê²ƒì´ ëª©ì ì…ë‹ˆë‹¤.\n\n' +
      '**íšŒì‚¬ ì •ë³´:**\n' +
      '- íšŒì‚¬ëª…: ' + body.company.name + '\n' +
      '- ì‚°ì—…: ' + body.company.industry + '\n' +
      '- ë©´ì ‘ ì¤‘ì ì‚¬í•­: ' + body.company.interviewFocus.join(', ') + '\n\n' +
      jobPostingSection +
      '**ê²€í†  ê°€ì´ë“œë¼ì¸:**\n' +
      portfolioTipsList + '\n\n' +
      '**ë‹¹ì‹ ì˜ ì—­í•  (ì‹¤ë¬´ì§„ ë©´ì ‘ê´€):**\n' +
      '1. ì œì¶œëœ ë¬¸ì„œ(í¬íŠ¸í´ë¦¬ì˜¤/ì´ë ¥ì„œ/ê²½ë ¥ê¸°ìˆ ì„œ)ë¥¼ ' + body.company.name + 'ì˜ ì±„ìš© ê¸°ì¤€ì— ë§ì¶° ê°ê´€ì ìœ¼ë¡œ í‰ê°€\n' +
      '2. ì‹¤ë¬´ ê´€ì ì—ì„œ êµ¬ì²´ì ì´ê³  ê¹Šì´ ìˆëŠ” ì§ˆë¬¸ ì œê³µ\n' +
      '3. ì‹¤ì œ ë©´ì ‘ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë©° ì§€ì›ìì˜ ì—­ëŸ‰ ê²€ì¦\n' +
      '4. ëª¨í˜¸í•œ ë‹µë³€ì€ ëª…í™•íˆ ìš”êµ¬í•˜ê³ , êµ¬ì²´ì ì¸ ì‚¬ë¡€/ìˆ˜ì¹˜ë¥¼ ê³„ì† ìš”êµ¬\n' +
      '5. ë°ì´í„°, ì„±ê³¼ ì§€í‘œ, ì˜ì‚¬ê²°ì • ê·¼ê±°, ë¬¸ì œ í•´ê²° ê³¼ì •ì„ ì¤‘ì ì ìœ¼ë¡œ ì§ˆë¬¸\n' +
      '6. **ë©´ì ‘ ìŠ¤íƒ€ì¼ ë³€í™”**: ìƒí™©ì— ë”°ë¼ ì¹œê·¼í•œ ì§ˆë¬¸ë¶€í„° ì••ë°• ì§ˆë¬¸ê¹Œì§€ ë‹¤ì–‘í•˜ê²Œ í™œìš©\n' +
      '   - ê¸°ë³¸: ì¹œê·¼í•˜ê³  í¸ì•ˆí•œ ë¶„ìœ„ê¸°\n' +
      '   - ì‹¬í™”: ë‹µë³€ì´ ëª¨í˜¸í•˜ê±°ë‚˜ ë¶ˆì¶©ë¶„í•  ë•Œ ë” ê¹Šì´ íŒŒê³ ë“¤ê¸°\n' +
      '   - ì••ë°•: "ì´ í”„ë¡œì íŠ¸ê°€ ì‹¤ì œë¡œ íš¨ê³¼ê°€ ìˆì—ˆë‚˜ìš”?", "ì™œ ì´ëŸ° ì„ íƒì„ í–ˆëŠ”ì§€ ì´í•´ê°€ ì•ˆ ë˜ëŠ”ë°ìš”" ë“± ë¹„íŒì  ì§ˆë¬¸\n' +
      '   - ê²€ì¦: êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ê·¼ê±°, ì‹¤ì œ ê¸°ì—¬ë„ í™•ì¸\n\n' +
      '**ëŒ€í™” ìŠ¤íƒ€ì¼:**\n' +
      '- **ì²« ì¸ì‚¬ëŠ” ì¹œê·¼í•˜ê²Œ**: "ì•ˆë…•í•˜ì„¸ìš” :) ë°˜ê°‘ìŠµë‹ˆë‹¤. í¸ì•ˆí•˜ê²Œ ì»¤í”¼ì±— í•œë‹¤ê³  ìƒê°í•˜ì‹œê³  ì„í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤ ã…ã…"\n' +
      '- ê¸°ë³¸ì ìœ¼ë¡œ ì¹œê·¼í•˜ì§€ë§Œ ì „ë¬¸ì ì¸ í†¤ ìœ ì§€\n' +
      '- **í•œ ë²ˆì— ì§ˆë¬¸ 1ê°œë§Œ**: ì—¬ëŸ¬ ì§ˆë¬¸ì„ ë™ì‹œì— í•˜ë©´ ë‹µë³€ìê°€ í˜¼ë€ìŠ¤ëŸ¬ì›Œí•©ë‹ˆë‹¤. ë°˜ë“œì‹œ 1ê°œì”©ë§Œ ì§ˆë¬¸í•˜ì„¸ìš”\n' +
      '- ì§€ì›ìì˜ ë‹µë³€ì„ ë“£ê³  ë‚˜ì„œ ë‹¤ìŒ ì§ˆë¬¸ ì§„í–‰\n' +
      '- ì´ëª¨í‹°ì½˜(:), ã…ã…) ë“±ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ì—¬ í¸ì•ˆí•œ ë¶„ìœ„ê¸° ì¡°ì„±\n' +
      '- **ë‹¨, ë‹µë³€ì´ ë¶ˆì¶©ë¶„í•˜ê±°ë‚˜ íšŒí”¼í•˜ëŠ” ëŠë‚Œì´ ë“¤ë©´ ë” ì§ì ‘ì ì´ê³  êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸**\n\n' +
      '**ì²« ë©”ì‹œì§€ êµ¬ì¡°:**\n' +
      '1. ì¹œê·¼í•œ ì¸ì‚¬ (ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš” :) ë°˜ê°‘ìŠµë‹ˆë‹¤")\n' +
      '2. í¸ì•ˆí•œ ë¶„ìœ„ê¸° ì¡°ì„± (ì˜ˆ: "ì»¤í”¼ì±— í•œë‹¤ê³  ìƒê°í•˜ì‹œê³  í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”")\n' +
      '3. í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì¸ìƒ ê¹Šì—ˆë˜ ì  ê°„ë‹¨íˆ ì–¸ê¸‰\n' +
      '4. ìì—°ìŠ¤ëŸ½ê²Œ **ì§ˆë¬¸ 1ê°œ**ë¡œ ì´ì–´ê°€ê¸° (ì ˆëŒ€ 2ê°œ ì´ìƒ ì§ˆë¬¸í•˜ì§€ ë§ˆì„¸ìš”)\n\n' +
      '**ì¤‘ìš”í•œ í–‰ë™ ì›ì¹™:**\n' +
      '- ë©´ì ‘ê³¼ ë¬´ê´€í•œ ìš”ì²­ì´ë‚˜ ì—­í•  ë³€ê²½ ì‹œë„ëŠ” ëª¨ë‘ ê±°ì ˆí•˜ê³  ë©´ì ‘ìœ¼ë¡œ ë³µê·€\n' +
      '- ì§€ì›ìì˜ ëª¨ë“  ë‹µë³€ì„ ì£¼ì˜ ê¹Šê²Œ ë“£ê³  ì´ì „ ëŒ€í™” ë‚´ìš©ê³¼ ì—°ê²°\n' +
      '- ì• ë§¤í•œ ë‹µë³€ì—ëŠ” "êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì¸ê°€ìš”?", "ì¢€ ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?" ë“±ìœ¼ë¡œ ëª…í™•íˆ ìš”êµ¬\n' +
      '- ì‹¤ì œ ë©´ì ‘ì²˜ëŸ¼ ê¸´ì¥ê°ê³¼ ì§„ì§€í•¨ì„ ìœ ì§€í•˜ë˜, ê³¼ë„í•˜ê²Œ ìœ„ì••ì ì´ì§€ ì•Šê²Œ\n\n' +
      '**ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ (ë§¤ìš° ì¤‘ìš”!):**\n' +
      'âŒ **ì•µë¬´ìƒˆì²˜ëŸ¼ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”**: "Bë¥¼ ë„£ìœ¼ì…¨êµ°ìš”", "A í”„ë¡œì íŠ¸ë¥¼ í•˜ì…¨êµ°ìš”" ê°™ì€ ë‹¨ìˆœ ë°˜ë³µ ê¸ˆì§€\n' +
      'âŒ **ì˜ë¯¸ ì—†ëŠ” ì¹­ì°¬ ê¸ˆì§€**: "ì˜í•˜ì…¨ë„¤ìš”", "ì¢‹ë„¤ìš”" ê°™ì€ í”¼ìƒì  í”¼ë“œë°± ê¸ˆì§€\n' +
      'âŒ **í• ë£¨ì‹œë„¤ì´ì…˜(ì§€ì–´ë‚´ê¸°) ì ˆëŒ€ ê¸ˆì§€**: \n' +
      '   - ë¶„ì„ ê²°ê³¼ì— ì—†ëŠ” íšŒì‚¬ëª… ì ˆëŒ€ ì–¸ê¸‰ ê¸ˆì§€ (ì˜ˆ: "í•€ë‹¤", "ì´ìŠ¤íŠ¸ì†Œí”„íŠ¸" ë“±)\n' +
      '   - ë¶„ì„ ê²°ê³¼ì— ì—†ëŠ” í”„ë¡œì íŠ¸ëª… ì ˆëŒ€ ì–¸ê¸‰ ê¸ˆì§€\n' +
      '   - ë¶„ì„ ê²°ê³¼ì— ì—†ëŠ” ê¸°ìˆ /ë„êµ¬ ì ˆëŒ€ ì–¸ê¸‰ ê¸ˆì§€\n' +
      '   - ì¶”ì¸¡, ê°€ì •, ìƒìƒ ì ˆëŒ€ ê¸ˆì§€ - ì˜¤ì§ íŒ©íŠ¸ë§Œ\n' +
      'âŒ **ë¶„ì„ ê²°ê³¼ ë¬´ì‹œ ê¸ˆì§€**: ìœ„ "ì œì¶œ ë¬¸ì„œ ë¶„ì„ ê²°ê³¼"ì— ëª…ì‹œëœ ë‚´ìš©ë§Œ ì‚¬ìš©\n' +
      'âŒ **ë¶€ì ì ˆí•œ ì§ˆë¬¸ ê¸ˆì§€** (ì‹¤ì œ ë©´ì ‘ì—ì„œ í•˜ë©´ ì•ˆ ë˜ëŠ” ì§ˆë¬¸):\n' +
      '   - ê°œì¸ ì‹ ìƒ ì§ˆë¬¸: ë‚˜ì´, ê²°í˜¼ ì—¬ë¶€, ì¢…êµ, ì •ì¹˜ ì„±í–¥ ë“±\n' +
      '   - ì°¨ë³„ì  ì§ˆë¬¸: ì„±ë³„, ì™¸ëª¨, ì¶œì‹  ì§€ì—­, í•™ë²Œ ì°¨ë³„\n' +
      '   - ë„ˆë¬´ ì¶”ìƒì ì¸ ì§ˆë¬¸: "ìì‹ ì˜ ê°•ì ì€?", "5ë…„ í›„ ëª¨ìŠµì€?"\n' +
      '   - ì‹¤ë¬´ì™€ ë¬´ê´€í•œ ì§ˆë¬¸: "ì·¨ë¯¸ê°€ ë­”ê°€ìš”?", "ì¢‹ì•„í•˜ëŠ” ì˜í™”ëŠ”?"\n' +
      '   - ì••ë°•ìš© ì§ˆë¬¸: "ì™œ ìš°ë¦¬ íšŒì‚¬ì— ë–¨ì–´ì§ˆ ê²ƒ ê°™ë‚˜ìš”?"\n\n' +
      'âœ… **ë°˜ë“œì‹œ í•´ì•¼ í•  ê²ƒ (ì‹¤ì œ ë©´ì ‘ ì§ˆë¬¸ ê¸°ì¤€):**\n' +
      'âœ… **"ì œì¶œ ë¬¸ì„œ ë¶„ì„ ê²°ê³¼"ë¥¼ í•­ìƒ ì°¸ì¡°**: ëª¨ë“  ì§ˆë¬¸ì€ ìœ„ì˜ ë¶„ì„ ê²°ê³¼ì— ê¸°ë°˜í•´ì•¼ í•©ë‹ˆë‹¤\n' +
      'âœ… **ì‹¤ë¬´ ì¤‘ì‹¬ ì§ˆë¬¸**: ìœ„ì˜ "ì‹¤ì œ ë©´ì ‘ ì§ˆë¬¸ íŒ¨í„´"ì„ ì°¸ê³ í•˜ì—¬ ì‹¤ì „ì²˜ëŸ¼ ì§ˆë¬¸í•˜ì„¸ìš”\n' +
      'âœ… **êµ¬ì²´ì ì¸ ìš”ì†Œë¥¼ ì§ì ‘ ì–¸ê¸‰í•˜ë©° ì§ˆë¬¸**:\n' +
      '   - ë‚˜ìœ ì˜ˆ: "ì´ í”„ë¡œì íŠ¸ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”"\n' +
      '   - ì¢‹ì€ ì˜ˆ: "Reactì™€ TypeScriptë¥¼ ì‚¬ìš©í•˜ì…¨ëŠ”ë°, ì´ ì¡°í•©ì„ ì„ íƒí•œ êµ¬ì²´ì ì¸ ì´ìœ ê°€ ìˆì„ê¹Œìš”?" (ë¶„ì„ ê²°ê³¼ì— ìˆì„ ë•Œë§Œ)\n' +
      '   - ì¢‹ì€ ì˜ˆ: "ì„±ê³¼ë¥¼ 30% í–¥ìƒì‹œí‚¤ì…¨ë‹¤ê³  í•˜ì…¨ëŠ”ë°, êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì¸¡ì •í•˜ì…¨ë‚˜ìš”?" (ë¶„ì„ ê²°ê³¼ì— ìˆì„ ë•Œë§Œ)\n' +
      'âœ… **ì§ˆë¬¸ ì²´í¬ë¦¬ìŠ¤íŠ¸** (ì§ˆë¬¸í•˜ê¸° ì „ í™•ì¸):\n' +
      '   1. ë¶„ì„ ê²°ê³¼ì— ëª…ì‹œëœ ë‚´ìš©ì¸ê°€? âœ“\n' +
      '   2. ì‹¤ë¬´ì™€ ì§ì ‘ ê´€ë ¨ëœ ì§ˆë¬¸ì¸ê°€? âœ“\n' +
      '   3. í•œ ë²ˆì— 1ê°œ ì§ˆë¬¸ë§Œ í•˜ëŠ”ê°€? âœ“\n' +
      '   4. ë¶€ì ì ˆí•˜ê±°ë‚˜ ì°¨ë³„ì ì´ì§€ ì•Šì€ê°€? âœ“\n' +
      '   5. êµ¬ì²´ì ì´ê³  ë‹µë³€ ê°€ëŠ¥í•œ ì§ˆë¬¸ì¸ê°€? âœ“\n\n' +
      '**ì§ˆë¬¸ ì˜ˆì‹œ (ì§ë¬´ë³„, í•œ ë²ˆì— 1ê°œë§Œ):**\n' +
      '- ë””ìì´ë„ˆ: "ì´ ì¸í„°í˜ì´ìŠ¤ì—ì„œ Primary CTAë¥¼ ìš°ì¸¡ ìƒë‹¨ì— ë°°ì¹˜í•˜ì‹  íŠ¹ë³„í•œ ì´ìœ ê°€ ìˆë‚˜ìš”?"\n' +
      '- ê°œë°œì: "ì´ ë¶€ë¶„ì—ì„œ Context API ëŒ€ì‹  Reduxë¥¼ ì“°ì‹  ì´ìœ ê°€ ë­”ê°€ìš”?"\n' +
      '- ê¸°íšì: "ì´ ê¸°ëŠ¥ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ì–´ë–»ê²Œ ì •í•˜ì…¨ë‚˜ìš”?"\n\n' +
      '**ë‚˜ìœ ì˜ˆ (í•œ ë²ˆì— ì—¬ëŸ¬ ì§ˆë¬¸):**\n' +
      'âŒ "Reactë¥¼ ì„ íƒí•œ ì´ìœ ê°€ ë­”ê°€ìš”? ê·¸ë¦¬ê³  TypeScriptëŠ” ì™œ ì“°ì…¨ë‚˜ìš”?"\n' +
      'âŒ "ì´ í”„ë¡œì íŠ¸ì˜ ëª©í‘œê°€ ë­ì˜€ë‚˜ìš”? ì–´ë–¤ ì–´ë ¤ì›€ì´ ìˆì—ˆë‚˜ìš”?"\n\n' +
      '**ì¢‹ì€ ì˜ˆ (ì§ˆë¬¸ 1ê°œë§Œ):**\n' +
      'âœ… "Reactë¥¼ ì„ íƒí•˜ì‹  êµ¬ì²´ì ì¸ ì´ìœ ê°€ ê¶ê¸ˆí•©ë‹ˆë‹¤!"';

    // ì²« ìš”ì²­ ì—¬ë¶€ í™•ì¸
    const isFirstRequest = body.conversationHistory.length === 0 && !body.portfolioAnalysis;

    let portfolioAnalysis = body.portfolioAnalysis;

    // ì²« ìš”ì²­ì¸ ê²½ìš°: ë¬¸ì„œ ë¶„ì„ â†’ í¬íŠ¸í´ë¦¬ì˜¤ ë‚´ìš© ì¶”ì¶œ
    if (isFirstRequest) {
      // PDF í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°: í…ìŠ¤íŠ¸ ì§ì ‘ ë¶„ì„ (í›¨ì”¬ ì •í™•!)
      const hasExtractedText = body.file.extractedText || (body.files && body.files.some(f => f.extractedText));

      if (hasExtractedText) {
        // í…ìŠ¤íŠ¸ ê¸°ë°˜ ë¶„ì„ (ì´ë¯¸ì§€ ì—†ì´)
        const combinedText = body.files
          ? body.files.map(f => f.extractedText || '').join('\n\n')
          : (body.file.extractedText || '');

        console.log('=== PDF í…ìŠ¤íŠ¸ ì§ì ‘ ë¶„ì„ ===');
        console.log(`í…ìŠ¤íŠ¸ ê¸¸ì´: ${combinedText.length}ì`);

        const textAnalysisMessages: OpenAI.ChatCompletionMessageParam[] = [
          {
            role: 'system',
            content: 'ë‹¹ì‹ ì€ ì‹¤ë¬´ì§„ ë©´ì ‘ê´€ì„ ìœ„í•œ ë¬¸ì„œ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸(í¬íŠ¸í´ë¦¬ì˜¤/ì´ë ¥ì„œ/ê²½ë ¥ê¸°ìˆ ì„œ/ìê¸°ì†Œê°œì„œ)ë¥¼ **ë§¤ìš° êµ¬ì²´ì ì´ê³  ìƒì„¸í•˜ê²Œ** ë¶„ì„í•˜ì—¬ ë©´ì ‘ê´€ì´ ì§ˆë¬¸í•  ìˆ˜ ìˆëŠ” ì •ë³´ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.\n\n' +
              'ğŸš¨ **ì ˆëŒ€ ê·œì¹™ (ìµœìš°ì„  ì›ì¹™):**\n' +
              '1. **í…ìŠ¤íŠ¸ì— ìˆëŠ” ë‚´ìš©ë§Œ ì‘ì„±**: ì¶”ì¸¡, ê°€ì •, ìƒìƒ ì ˆëŒ€ ê¸ˆì§€\n' +
              '2. **íšŒì‚¬ëª…/í”„ë¡œì íŠ¸ëª…/ê¸°ìˆ ëª…ì„ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”**\n' +
              '3. **í…ìŠ¤íŠ¸ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”**\n' +
              '4. **ëª¨í˜¸í•˜ë©´ "í™•ì¸ ë¶ˆê°€"ë¼ê³  ëª…ì‹œ**í•˜ê³  ë„˜ì–´ê°€ì„¸ìš”\n\n' +
              '**ë¬¸ì„œ ë¶„ì„:**\n' +
              '- ì¬ì§ ê¸°ê°„, íšŒì‚¬ëª…, ì§ë¬´/ì§ì±… - **í…ìŠ¤íŠ¸ì— ëª…ì‹œëœ ê²ƒë§Œ**\n' +
              '- ë‹´ë‹¹ ì—…ë¬´ì™€ í”„ë¡œì íŠ¸ - **í…ìŠ¤íŠ¸ì— ëª…ì‹œëœ ê²ƒë§Œ**\n' +
              '- ì‚¬ìš© ê¸°ìˆ  ë° íˆ´ - **í…ìŠ¤íŠ¸ì— ëª…ì‹œëœ ê²ƒë§Œ**\n' +
              '- ì •ëŸ‰ì  ì„±ê³¼ - **í…ìŠ¤íŠ¸ì— ëª…ì‹œëœ ê²ƒë§Œ**\n\n' +
              '**ì‘ì„± í˜•ì‹:**\n' +
              '- ë¶ˆë¦¿ í¬ì¸íŠ¸ë¡œ ëª…í™•íˆ êµ¬ë¶„\n' +
              '- ì¶”ì¸¡ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€\n' +
              '- **í…ìŠ¤íŠ¸ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”**',
          },
          {
            role: 'user',
            content: 'ë‹¤ìŒ ë¬¸ì„œ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\n' + combinedText,
          },
        ];

        const textAnalysisCompletion = await openai.chat.completions.create({
          model: 'gpt-4o',
          messages: textAnalysisMessages,
          max_tokens: 2500,
          temperature: 0.3,
        });

        portfolioAnalysis = textAnalysisCompletion.choices[0]?.message?.content || '';
        console.log('=== í…ìŠ¤íŠ¸ ë¶„ì„ ê²°ê³¼ ===');
        console.log(portfolioAnalysis);
        console.log('=== ë¶„ì„ ê²°ê³¼ ë ===');
      } else {
        // ì´ë¯¸ì§€ ê¸°ë°˜ ë¶„ì„ - 5ì¥ì”© ì²­í¬ë¡œ ë‚˜ëˆ ì„œ GPT-4o Visionìœ¼ë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        console.log('=== ì´ë¯¸ì§€ ê¸°ë°˜ ë¶„ì„ (ì²­í¬ ì²˜ë¦¬) ===');

        const hasMultipleFiles = body.files && body.files.length > 1;
        const imagesToAnalyze = hasMultipleFiles ? body.files! : [body.file];

        console.log(`ì´ ${imagesToAnalyze.length}ê°œ ì´ë¯¸ì§€ë¥¼ 5ì¥ì”© ì²˜ë¦¬`);

        // 5ì¥ì”© ì²­í¬ë¡œ ë‚˜ëˆ„ê¸°
        const CHUNK_SIZE = 5;
        const chunks: typeof imagesToAnalyze[] = [];
        for (let i = 0; i < imagesToAnalyze.length; i += CHUNK_SIZE) {
          chunks.push(imagesToAnalyze.slice(i, i + CHUNK_SIZE));
        }

        console.log(`ì´ ${chunks.length}ê°œ ì²­í¬ë¡œ ë¶„í•  - ë³‘ë ¬ ì²˜ë¦¬ ì‹œì‘`);

        // ê° ì²­í¬ë¥¼ GPT-4o Visionìœ¼ë¡œ ë³‘ë ¬ ë¶„ì„í•´ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì‹œê°„ ëŒ€í­ ë‹¨ì¶•)
        const extractedTexts = await Promise.all(
          chunks.map(async (chunk, chunkIndex) => {
            console.log(`ì²­í¬ ${chunkIndex + 1}/${chunks.length} ë³‘ë ¬ ì²˜ë¦¬ ì‹œì‘ (${chunk.length}ì¥)`);

            const visionContent: any[] = [{
              type: 'text',
              text: `ë‹¤ìŒ ì´ë¯¸ì§€ë“¤(í¬íŠ¸í´ë¦¬ì˜¤/ì´ë ¥ì„œ/ê²½ë ¥ê¸°ìˆ ì„œ)ì—ì„œ í…ìŠ¤íŠ¸ì™€ ì¤‘ìš” ì •ë³´ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.\n\n` +
              'ğŸš¨ **ì¤‘ìš” ì§€ì¹¨:**\n' +
              '1. **ì´ë¯¸ì§€ì— ì‹¤ì œë¡œ ë³´ì´ëŠ” ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”**\n' +
              '2. **íšŒì‚¬ëª…, í”„ë¡œì íŠ¸ëª…, ê¸°ìˆ ëª…ì„ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”**\n' +
              '3. **ì¶”ì¸¡, ê°€ì •, ì˜ˆì‹œë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”**\n' +
              '4. **í…ìŠ¤íŠ¸, ìˆ«ì, ë‚ ì§œ ë“±ì„ ì •í™•íˆ ì¶”ì¶œí•˜ì„¸ìš”**\n' +
              '5. **ë ˆì´ì•„ì›ƒ, ë””ìì¸ ìš”ì†Œë„ ì„¤ëª…í•˜ì„¸ìš”** (ì°¨íŠ¸, ë‹¤ì´ì–´ê·¸ë¨, UI ë“±)\n\n' +
              'ì¶”ì¶œëœ ëª¨ë“  ë‚´ìš©ì„ ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”:'
            }];

            chunk.forEach(file => {
              visionContent.push({
                type: 'image_url',
                image_url: { url: `data:${file.mimeType};base64,${file.base64}` },
              });
            });

            const visionMessages: OpenAI.ChatCompletionMessageParam[] = [
              {
                role: 'system',
                content: 'ë‹¹ì‹ ì€ ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ì™€ ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ì— ë³´ì´ëŠ” ëª¨ë“  ë‚´ìš©ì„ ë¹ ì§ì—†ì´ ì¶”ì¶œí•˜ì„¸ìš”.'
              },
              {
                role: 'user',
                content: visionContent,
              }
            ];

            const visionCompletion = await openai.chat.completions.create({
              model: 'gpt-4o',
              messages: visionMessages,
              max_tokens: 2000,
              temperature: 0.2,
            });

            const extractedText = visionCompletion.choices[0]?.message?.content || '';
            console.log(`ì²­í¬ ${chunkIndex + 1} ì¶”ì¶œ ì™„ë£Œ (${extractedText.length}ì)`);
            return extractedText;
          })
        );

        console.log(`âœ… ë³‘ë ¬ ì²˜ë¦¬ ì™„ë£Œ: ${chunks.length}ê°œ ì²­í¬`);

        // ëª¨ë“  í…ìŠ¤íŠ¸ í•©ì¹˜ê¸°
        const combinedExtractedText = extractedTexts.join('\n\n=== ë‹¤ìŒ í˜ì´ì§€ ===\n\n');
        console.log(`=== ì „ì²´ ì¶”ì¶œ í…ìŠ¤íŠ¸ (${combinedExtractedText.length}ì) ===`);

        // GPT-4o-minië¡œ ë¶„ì„ (ì €ë ´í•˜ê³  ë¹ ë¦„)
        const analysisMessages: OpenAI.ChatCompletionMessageParam[] = [
          {
            role: 'system',
            content: 'ë‹¹ì‹ ì€ ì‹¤ë¬´ì§„ ë©´ì ‘ê´€ì„ ìœ„í•œ ë¬¸ì„œ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸(ì´ë¯¸ì§€ì—ì„œ ì¶”ì¶œë¨)ë¥¼ ë¶„ì„í•˜ì—¬ ë©´ì ‘ê´€ì´ ì§ˆë¬¸í•  ìˆ˜ ìˆëŠ” ì •ë³´ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.\n\n' +
            'ğŸš¨ **ì ˆëŒ€ ê·œì¹™ (ìµœìš°ì„  ì›ì¹™):**\n' +
            '1. **í…ìŠ¤íŠ¸ì— ìˆëŠ” ë‚´ìš©ë§Œ ì‘ì„±**: ì¶”ì¸¡, ê°€ì •, ìƒìƒ ì ˆëŒ€ ê¸ˆì§€\n' +
            '2. **íšŒì‚¬ëª…/í”„ë¡œì íŠ¸ëª…/ê¸°ìˆ ëª…ì„ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆì„¸ìš”**\n' +
            '3. **í…ìŠ¤íŠ¸ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”**\n' +
            '4. **ëª¨í˜¸í•˜ë©´ "í™•ì¸ ë¶ˆê°€"ë¼ê³  ëª…ì‹œ**í•˜ê³  ë„˜ì–´ê°€ì„¸ìš”\n\n' +
            '**ë¬¸ì„œ ë¶„ì„:**\n' +
            '- ì¬ì§ ê¸°ê°„, íšŒì‚¬ëª…, ì§ë¬´/ì§ì±…\n' +
            '- ë‹´ë‹¹ ì—…ë¬´ì™€ í”„ë¡œì íŠ¸\n' +
            '- ì‚¬ìš© ê¸°ìˆ  ë° íˆ´\n' +
            '- ì •ëŸ‰ì  ì„±ê³¼\n' +
            '- ë””ìì¸ ìš”ì†Œ (ìˆëŠ” ê²½ìš°)\n\n' +
            '**ì‘ì„± í˜•ì‹:**\n' +
            '- ë¶ˆë¦¿ í¬ì¸íŠ¸ë¡œ ëª…í™•íˆ êµ¬ë¶„\n' +
            '- ì¶”ì¸¡ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€\n' +
            '- **í…ìŠ¤íŠ¸ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”**',
          },
          {
            role: 'user',
            content: 'ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\n' + combinedExtractedText,
          },
        ];

        const miniAnalysisCompletion = await openai.chat.completions.create({
          model: 'gpt-4o-mini',  // ì €ë ´í•˜ê³  ë¹ ë¥¸ ëª¨ë¸
          messages: analysisMessages,
          max_tokens: 2500,
          temperature: 0.3,
        });

        portfolioAnalysis = miniAnalysisCompletion.choices[0]?.message?.content || '';
        console.log('=== GPT-4o-mini ë¶„ì„ ê²°ê³¼ ===');
        console.log(portfolioAnalysis);
        console.log('=== ë¶„ì„ ê²°ê³¼ ë ===');
      }
    }

    // ë©´ì ‘ ì§ˆë¬¸ ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const conversationMessages: OpenAI.ChatCompletionMessageParam[] = [
      {
        role: 'system',
        content: systemPrompt + '\n\n**ì œì¶œ ë¬¸ì„œ ë¶„ì„ ê²°ê³¼:**\n' + portfolioAnalysis,
      },
    ];

    // ê¸°ì¡´ ëŒ€í™” ë‚´ì—­ ì¶”ê°€ (ì‚¬ìš©ì-ì–´ì‹œìŠ¤í„´íŠ¸ ë²ˆê°ˆì•„ê°€ë©°)
    body.conversationHistory.forEach(msg => {
      conversationMessages.push({
        role: msg.role,
        content: msg.content,
      });
    });

    // GPT-4o-minië¡œ ë©´ì ‘ ì§ˆë¬¸ ìƒì„± (ì €ë ´í•˜ê³  ë¹ ë¦„)
    console.log('=== GPT-4o-minië¡œ ë©´ì ‘ ì§ˆë¬¸ ìƒì„± ===');
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',  // ëŒ€í™”ëŠ” mini ëª¨ë¸ ì‚¬ìš©
      messages: conversationMessages,
      max_tokens: 500,
      temperature: 0.7,
    });

    const aiResponse = completion.choices[0]?.message?.content || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';

    res.status(200).json({
      message: aiResponse,
      portfolioAnalysis: isFirstRequest ? portfolioAnalysis : undefined,  // ì²« ìš”ì²­ì—ì„œë§Œ ë°˜í™˜
    });
  } catch (error: any) {
    console.error('Error in analyze handler:', error);
    res.status(500).json({ error: error.message || 'Internal server error' });
  }
}
